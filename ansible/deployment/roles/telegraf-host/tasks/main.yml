---
# Playbook for Alpine host

  - name: Install Telegraf
    become: true
    package: name=telegraf state=installed
    when: config_only == false

#  - name: Add telegraf user to sudo
#    become: true
#    copy:
#      dest: /etc/sudoers.d/telegraf
#      src: sudoers.d/telegraf
#      mode: 0440
#    when: config_only == false

  - name: Configure telegraf
    become: true
    copy:
      dest: /etc/telegraf.conf
      src: telegraf.conf

  - name: Create dir "/usr/local/sbin/"
    file:
      path: /usr/local/sbin/
      state: directory

  - name: Deploy LXD monitoring script
    become: true
    copy:
      dest: /usr/local/sbin/telegraf-lxd-stats
      src: usr/local/sbin/telegraf-lxd-stats
      owner: telegraf
      mode: +x

  - name: Add telegraf config for LXD
    become: true
    copy:
      dest: /etc/telegraf.conf.d/
      src: telegraf.d/

  - name: Start Telegraf
    become: true
    service: name=telegraf state=restarted enabled=yes
